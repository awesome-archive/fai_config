#! /bin/bash

# (c) Michael Goetze, 2011, mgoetze@mgoetze.net
# (c) Thomas Lange 2014

error=0; trap 'error=$(($?>$error?$?:$error))' ERR # save maximum error code

if [ -r $LOGDIR/disk_var.sh ] ; then
	. $LOGDIR/disk_var.sh
else
	echo "disk_var.sh not found!"
	exit 1
fi


# CentOS 7 does not have a device.map file, so generate one
if [ -d $target/boot/grub2 -a ! -f $target/boot/grub2/device.map ]; then
    echo "# Generated by FAI" >> $target/boot/grub2/device.map
    centosdisks=$(awk '/[sv]d.$/ {print $4}' /proc/partitions | sort)
    dcount=0
    for d in $centosdisks; do
        echo "(hd$dcount)    /dev/$d" >> $target/boot/grub2/device.map
        dcount=$((dcount + 1))
    done
fi

bootdev=`device2grub $BOOT_DEVICE`
bootpart=`device2grub $BOOT_PARTITION`
version=`$ROOTCMD rpm -qv kernel | cut -d- -f2-`

if grep '[[:space:]]/boot[[:space:]]' $LOGDIR/fstab; then
	bootdir=''
else
	bootdir='/boot'
fi

mount -o bind /dev $target/dev

if [ -f $target/usr/sbin/grub2-install ]; then

# CentOS 7
#generate grub2 config
cat <<'EOF' > $target/etc/default/grub
# If you change this file, run 'grub2-mkconfig --output=/boot/grub2/grub.cfg' afterwards to update grub2
# For full documentation of the options in this file, see:
#   info -f grub -n 'Simple configuration'

GRUB_DEFAULT=0
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR=`lsb_release -i -s 2> /dev/null || echo CentOS`
GRUB_CMDLINE_LINUX_DEFAULT="elevator=deadline crashkernel=384M-2G:64M,2G-:128M vt.cur_default=50 transparent_hugepage=never cgroup_enable=memory swapaccount=1 intel_pstate=disable thermal.off=1 cpufreq.off=1 idle=halt net.ifnames=0 biosdevname=0"
GRUB_CMDLINE_LINUX=""

# Uncomment to enable BadRAM filtering, modify to suit your needs
# This works with Linux (no patch required) and with any kernel that obtains
# the memory map information from GRUB (GNU Mach, kernel of FreeBSD ...)
#GRUB_BADRAM="0x01234567,0xfefefefe,0x89abcdef,0xefefefef"

# Uncomment to disable graphical terminal (grub-pc only)
#GRUB_TERMINAL=console

# The resolution used on graphical terminal
# note that you can use only modes which your graphic card supports via VBE
# you can see them in real GRUB with the command `vbeinfo'
GRUB_GFXMODE=1024x768

# Uncomment if you don't want GRUB to pass "root=UUID=xxx" parameter to Linux
#GRUB_DISABLE_LINUX_UUID=true

# Uncomment to disable generation of recovery mode menu entries
#GRUB_DISABLE_RECOVERY="true"

# Uncomment to get a beep at grub start
#GRUB_INIT_TUNE="480 440 1"
GRUB_GFXPAYLOAD_LINUX="$GRUB_GFXMODE"
GRUB_DISABLE_OS_PROBER=true
EOF

    $ROOTCMD grub2-install --no-floppy "$BOOT_DEVICE"
    $ROOTCMD grub2-mkconfig --output=/boot/grub2/grub.cfg
else

$ROOTCMD grub-install --just-copy

$ROOTCMD grub --device-map=/dev/null --no-floppy --batch <<-EOF
device $bootdev $BOOT_DEVICE
root $bootpart
setup $bootdev
quit
EOF

ln -s ./menu.lst $target/boot/grub/grub.conf

if [ -f $target/boot/grub/splash.xpm.gz ]; then
	pretty="splashimage=$bootpart$bootdir/grub/splash.xpm.gz"
else
	pretty="color cyan/blue white/blue"
fi

if [ -f $target/sbin/dracut -o -f $target/usr/sbin/dracut ]; then
    # CentOS 6
    iname=initramfs
else
    # CentOS 5
    iname=initrd
fi
title=`head -1 $target/etc/redhat-release`

cat > $target/boot/grub/grub.conf <<-EOF
	timeout 5
	default 0
	$pretty
	hiddenmenu
	
	title $title
	  root $bootpart
	  kernel $bootdir/vmlinuz-$version root=$ROOT_PARTITION ro elevator=deadline vt.cur_default=50 transparent_hugepage=never cgroup_enable=memory swapaccount=1 intel_pstate=disable thermal.off=1 idle=halt net.ifnames=0 biosdevname=0
	  initrd $bootdir/$iname-$version.img
	EOF

fi

umount $target/dev

echo ""
echo "Grub installed on $BOOT_DEVICE = $bootdev"
echo "Grub boot partition is $BOOT_PARTITION = $bootpart"
echo "Root partition is $ROOT_PARTITION"
echo "Boot kernel: $version"

exit $error
